Non-negotiable constraint
Do not alter any existing functions in 1.1.0_birha.py. Treat them as read-only reference.
You may only add new functions, dataclasses, constants, and unit tests.
No renames, no signature changes, no in-place edits, no deleted lines in existing code.

---

# Full Prompt (Thorough) – Task 10

**Context**
You are enhancing *Birha v1.1.0* (Tkinter app). The source of truth is **@Prompt_CODEX.txt** and **@0.1.7.3 Axioms_framework Engineering Contract — Birha V1.1.docx**. Implement **Task 10 only**: the Non-Explicit Linking Flow, ensuring Secondary verses (Explicit?=0) are linked to one or more Primary verses. All changes must be additive. 

---

**Non-negotiables**

* Do **not** alter any existing functions, constants, or strings in `1.1.0_birha.py`.
* No renames, refactors, in-place edits, or deletions.
* Add all new code only under this header:
  `# === Axioms T10: Non-Explicit Linking Flow (additive only) ===`
* Canonical headers and string constants must remain untouched.

---

**Deliverables**

1. **New UI dialog**
   `class NonExplicitLinkDialog(tk.Toplevel):`

* Launched when user finalizes an axiom for a verse with `Explicit?=0`.
* Provides search box + list of candidate Primary verses (from `AxiomContribStore` with category=Primary).
* Allows selecting one or more supporting Primaries.
* Shows warnings if none selected.
* On save: writes parent/supporting relations to `AxiomContributions`.

2. **New functions**

```python
def link_secondary_to_primary(
    secondary_verse_key: str,
    primary_verse_keys: List[str],
    store_path: Optional[Union[str, Path]] = None
) -> None:
    """
    Persist supporting relations for a Secondary verse.
    Raises ValueError if no primary_verse_keys provided.
    Detects and rejects circular references.
    """

def find_candidate_primaries(
    store_path: Optional[Union[str, Path]] = None
) -> List[dict]:
    """
    Return list of all Primary contributions in the store
    (axiom_id, verse_key, category).
    """
```

3. **Logic rules**

* Secondary verses **must** link to at least one Primary; otherwise finalization is blocked.
* Store the relation by writing supporting rows in `AxiomContributions` with fields:

  * `axiom_id` (from the selected Primary)
  * `verse_key` (Secondary’s key)
  * `category="Secondary"`
  * `is_supporting_of=primary_verse_key`
* Detect circular references (no Secondary can indirectly support itself through chains).

---

**Acceptance Criteria**

* When Explicit?=0, finalization triggers the Non-Explicit Link dialog.
* User must select ≥1 Primary; cannot save without this.
* Relations persisted to `AxiomContributions` correctly (including `is_supporting_of`).
* Circular references are rejected with clear error.
* Unit tests confirm:

  * Attempt to finalize with no Primary raises ValueError.
  * Linking succeeds with valid Primary(s).
  * Circular detection prevents invalid chains.
* No regressions to existing Explicit (Primary) linking flows.

---

**Tests**
File: `tests/axioms/test_task10_nonexplicit.py`

* `test_link_secondary_requires_primary()` → must raise if no primaries.
* `test_link_secondary_to_single_primary()` → persists relation correctly.
* `test_link_secondary_to_multiple_primaries()` → all links recorded.
* `test_detect_circular_reference()` → reject loop.
* `test_find_candidate_primaries_returns_only_primary()` → returns correct filtered list.
* Use `TemporaryDirectory` and mock Excel stores for isolation.

---

**PR Workflow**

* Branch: `feature/axioms-T10-nonexplicit-linking`
* Commit: `feat(axioms): T10 add Non-Explicit Linking Flow (Secondary → Primary)`
* PR Title: `Axioms T10 — Non-Explicit Linking Flow (Secondary → Primary)`
* PR Body Checklist:

  * [ ] Additive only, no edits to existing functions/constants
  * [ ] Secondary verses cannot finalize without Primary link(s)
  * [ ] Parent/supporting relations stored in AxiomContributions
  * [ ] Circular references prevented
  * [ ] Unit tests green

---